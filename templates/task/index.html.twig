{% extends 'layout.html.twig' %}

{% block title %}My Tasks - WorkFlow{% endblock %}

{% block content %}
<div class="space-y-6">
    {# Header #}
    <div class="sm:flex sm:items-center sm:justify-between">
        <div>
            <h1 class="text-xl font-semibold text-gray-900">My Tasks</h1>
            <p class="mt-2 text-sm text-gray-700">All tasks assigned to you across all projects.</p>
        </div>
    </div>

    {# Filter Bar #}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <form method="GET" action="{{ path('app_task_my_tasks') }}" id="task-filter-form" class="space-y-4">
            {# Search and main filters row #}
            <div class="flex flex-wrap items-center gap-3">
                {# Search #}
                <div class="flex-1 min-w-[200px] max-w-md">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                        <input type="text" name="search" value="{{ filter.search }}" placeholder="Search tasks..."
                               class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    </div>
                </div>

                {# Status Filter #}
                <div class="relative" x-data="{ open: false }">
                    <button type="button" @click="open = !open" @click.away="open = false"
                            class="inline-flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <span>Status</span>
                        {% if filter.statuses|length > 0 %}
                            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-semibold text-white bg-primary-600 rounded-full">{{ filter.statuses|length }}</span>
                        {% endif %}
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div x-show="open" x-transition class="absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                        <div class="p-2 space-y-1">
                            {% for status in ['todo', 'in_progress', 'in_review', 'completed'] %}
                                {% set statusLabels = {'todo': 'To Do', 'in_progress': 'In Progress', 'in_review': 'In Review', 'completed': 'Completed'} %}
                                <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" name="status_{{ status }}" value="{{ status }}"
                                           {% if status in filter.statuses|map(s => s.value) %}checked{% endif %}
                                           class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                    <span class="text-sm text-gray-700">{{ statusLabels[status] }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                {# Priority Filter #}
                <div class="relative" x-data="{ open: false }">
                    <button type="button" @click="open = !open" @click.away="open = false"
                            class="inline-flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <span>Priority</span>
                        {% if filter.priorities|length > 0 %}
                            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-semibold text-white bg-primary-600 rounded-full">{{ filter.priorities|length }}</span>
                        {% endif %}
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div x-show="open" x-transition class="absolute left-0 mt-2 w-40 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                        <div class="p-2 space-y-1">
                            {% for priority in ['high', 'medium', 'low', 'none'] %}
                                {% set priorityLabels = {'none': 'None', 'low': 'Low', 'medium': 'Medium', 'high': 'High'} %}
                                <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" name="priority_{{ priority }}" value="{{ priority }}"
                                           {% if priority in filter.priorities|map(p => p.value) %}checked{% endif %}
                                           class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                    <span class="text-sm text-gray-700">{{ priorityLabels[priority] }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                {# Due Date Filter #}
                <div class="relative" x-data="{ open: false }">
                    <button type="button" @click="open = !open" @click.away="open = false"
                            class="inline-flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <span>Due Date</span>
                        {% if filter.dueFilter %}
                            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-semibold text-white bg-primary-600 rounded-full">1</span>
                        {% endif %}
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div x-show="open" x-transition class="absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                        <div class="p-2 space-y-1">
                            {% for dueOption in [
                                {'value': '', 'label': 'Any date'},
                                {'value': 'overdue', 'label': 'Overdue'},
                                {'value': 'today', 'label': 'Due today'},
                                {'value': 'this_week', 'label': 'This week'},
                                {'value': 'next_week', 'label': 'Next week'},
                                {'value': 'no_date', 'label': 'No due date'}
                            ] %}
                                <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="due" value="{{ dueOption.value }}"
                                           {% if filter.dueFilter == dueOption.value or (filter.dueFilter is null and dueOption.value == '') %}checked{% endif %}
                                           class="border-gray-300 text-primary-600 focus:ring-primary-500">
                                    <span class="text-sm text-gray-700">{{ dueOption.label }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                {# Project Filter #}
                {% if userProjects|length > 1 %}
                <div class="relative" x-data="{ open: false }">
                    <button type="button" @click="open = !open" @click.away="open = false"
                            class="inline-flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <span>Project</span>
                        {% if filter.projectIds|length > 0 %}
                            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-semibold text-white bg-primary-600 rounded-full">{{ filter.projectIds|length }}</span>
                        {% endif %}
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div x-show="open" x-transition class="absolute left-0 mt-2 w-56 max-h-64 overflow-y-auto bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                        <div class="p-2 space-y-1">
                            {% for project in userProjects %}
                                {% set projectIdStr = '' ~ project.id %}
                                <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" name="project_{{ projectIdStr }}" value="{{ projectIdStr }}"
                                           {% if projectIdStr in filter.projectIds %}checked{% endif %}
                                           class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                    <span class="text-sm text-gray-700 truncate">{{ project.name }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {# Assignee Filter #}
                {% if projectMembers|length > 1 %}
                <div class="relative" x-data="{ open: false }">
                    <button type="button" @click="open = !open" @click.away="open = false"
                            class="inline-flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <span>Assignee</span>
                        {% if filter.assigneeIds|length > 0 %}
                            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-semibold text-white bg-primary-600 rounded-full">{{ filter.assigneeIds|length }}</span>
                        {% endif %}
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div x-show="open" x-transition class="absolute left-0 mt-2 w-64 max-h-64 overflow-y-auto bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                        <div class="p-2 space-y-1">
                            {% for member in projectMembers %}
                                {% set memberIdStr = '' ~ member.id %}
                                <label class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" name="assignee_{{ memberIdStr }}" value="{{ memberIdStr }}"
                                           {% if memberIdStr in filter.assigneeIds %}checked{% endif %}
                                           class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                    <span class="inline-flex h-6 w-6 items-center justify-center rounded-full overflow-hidden flex-shrink-0">
                                        {% if member.avatar %}
                                            <img src="{{ app.request.basePath }}/uploads/avatars/{{ member.avatar }}" alt="{{ member.fullName }}" class="w-full h-full object-cover">
                                        {% else %}
                                            <span class="w-full h-full bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center">
                                                <span class="text-xs font-medium text-white">{{ member.firstName|slice(0,1)|upper }}</span>
                                            </span>
                                        {% endif %}
                                    </span>
                                    <span class="text-sm text-gray-700 truncate">{{ member.fullName }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {# Apply Button #}
                <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                    Apply
                </button>

                {# Clear Filters #}
                {% if filter.hasActiveFilters %}
                <a href="{{ path('app_task_my_tasks') }}" class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Clear filters
                </a>
                {% endif %}
            </div>

            {# Active Filters Display #}
            {% if filter.hasActiveFilters %}
            <div class="flex flex-wrap items-center gap-2 pt-2 border-t border-gray-100">
                <span class="text-xs text-gray-500">Active filters:</span>
                {% if filter.statuses|length > 0 %}
                    {% for status in filter.statuses %}
                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">
                            {{ status.label }}
                        </span>
                    {% endfor %}
                {% endif %}
                {% if filter.priorities|length > 0 %}
                    {% for priority in filter.priorities %}
                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">
                            {{ priority.label }}
                        </span>
                    {% endfor %}
                {% endif %}
                {% if filter.dueFilter %}
                    {% set dueLabels = {'overdue': 'Overdue', 'today': 'Due today', 'this_week': 'This week', 'next_week': 'Next week', 'no_date': 'No due date', 'custom': 'Custom date'} %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full">
                        {{ dueLabels[filter.dueFilter] ?? filter.dueFilter }}
                    </span>
                {% endif %}
                {% if filter.assigneeIds|length > 0 %}
                    {% for assigneeId in filter.assigneeIds %}
                        {% for member in projectMembers %}
                            {% if ('' ~ member.id) == assigneeId %}
                                <span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">
                                    {{ member.fullName }}
                                </span>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                {% endif %}
                {% if filter.search %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">
                        "{{ filter.search }}"
                    </span>
                {% endif %}
                <span class="text-xs text-gray-500 ml-2">{{ tasks|length }} task{{ tasks|length != 1 ? 's' : '' }} found</span>
            </div>
            {% endif %}
        </form>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('task-filter-form');

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(form);
            const params = new URLSearchParams();

            // Collect status checkboxes
            const statuses = [];
            form.querySelectorAll('input[name^="status_"]:checked').forEach(cb => {
                statuses.push(cb.value);
            });
            if (statuses.length > 0) {
                params.set('status', statuses.join(','));
            }

            // Collect priority checkboxes
            const priorities = [];
            form.querySelectorAll('input[name^="priority_"]:checked').forEach(cb => {
                priorities.push(cb.value);
            });
            if (priorities.length > 0) {
                params.set('priority', priorities.join(','));
            }

            // Collect project checkboxes
            const projects = [];
            form.querySelectorAll('input[name^="project_"]:checked').forEach(cb => {
                projects.push(cb.value);
            });
            if (projects.length > 0) {
                params.set('project', projects.join(','));
            }

            // Collect assignee checkboxes
            const assignees = [];
            form.querySelectorAll('input[name^="assignee_"]:checked').forEach(cb => {
                assignees.push(cb.value);
            });
            if (assignees.length > 0) {
                params.set('assignee', assignees.join(','));
            }

            // Due date
            const dueRadio = form.querySelector('input[name="due"]:checked');
            if (dueRadio && dueRadio.value) {
                params.set('due', dueRadio.value);
            }

            // Search
            const search = form.querySelector('input[name="search"]').value.trim();
            if (search) {
                params.set('search', search);
            }

            // Redirect with params
            const queryString = params.toString();
            window.location.href = '{{ path('app_task_my_tasks') }}' + (queryString ? '?' + queryString : '');
        });
    });
    </script>

    {% if tasks|length > 0 %}
        {# Kanban Board #}
        <div id="kanban-board" data-status-url-template="{{ path('app_task_update_status', {id: '__TASK_ID__'}) }}" data-reorder-url="{{ path('app_task_reorder') }}" class="kanban-grid">
            {# To Do Column #}
            <div class="kanban-column rounded-lg bg-gray-100 flex flex-col" data-status="todo"
                 ondragover="kanbanDragOver(event)"
                 ondragleave="kanbanDragLeave(event)"
                 ondrop="kanbanDrop(event, 'todo')">
                {# Expanded Header #}
                <div class="kanban-header p-4 pb-0">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <span class="kanban-title-badge inline-flex items-center rounded-full bg-gray-500 px-3 py-1 text-xs font-medium text-white">
                                To Do (<span class="kanban-count">{{ tasksByStatus.todo|length }}</span>)
                            </span>
                        </div>
                        <div class="flex items-center gap-1">
                            <button type="button" class="kanban-collapse-btn p-1 rounded hover:bg-gray-200 text-gray-500 hover:text-gray-700" title="Collapse">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="kanban-content p-4 pt-0 flex-1">
                    <div class="kanban-dropzone space-y-3 h-full">
                        {% for task in tasksByStatus.todo %}
                            {% include 'task/_card.html.twig' with {task: task, draggable: true} %}
                        {% endfor %}
                    </div>
                </div>
                {# Collapsed State #}
                <div class="kanban-collapsed-content">
                    <button type="button" class="kanban-expand-btn p-1 rounded hover:bg-gray-200 text-gray-500 hover:text-gray-700 mb-2" title="Expand">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
                        </svg>
                    </button>
                    <div class="kanban-vertical-title">
                        <span class="kanban-title-badge inline-flex items-center rounded-full bg-gray-500 px-3 py-1 text-xs font-medium text-white whitespace-nowrap">
                            To Do (<span class="kanban-count-collapsed">{{ tasksByStatus.todo|length }}</span>)
                        </span>
                    </div>
                </div>
            </div>

            {# In Progress Column #}
            <div class="kanban-column rounded-lg bg-blue-50 flex flex-col" data-status="in_progress"
                 ondragover="kanbanDragOver(event)"
                 ondragleave="kanbanDragLeave(event)"
                 ondrop="kanbanDrop(event, 'in_progress')">
                {# Expanded Header #}
                <div class="kanban-header p-4 pb-0">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <span class="kanban-title-badge inline-flex items-center rounded-full bg-blue-500 px-3 py-1 text-xs font-medium text-white">
                                In Progress (<span class="kanban-count">{{ tasksByStatus.in_progress|length }}</span>)
                            </span>
                        </div>
                        <div class="flex items-center gap-1">
                            <button type="button" class="kanban-collapse-btn p-1 rounded hover:bg-blue-100 text-blue-500 hover:text-blue-700" title="Collapse">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="kanban-content p-4 pt-0 flex-1">
                    <div class="kanban-dropzone space-y-3 h-full">
                        {% for task in tasksByStatus.in_progress %}
                            {% include 'task/_card.html.twig' with {task: task, draggable: true} %}
                        {% endfor %}
                    </div>
                </div>
                {# Collapsed State #}
                <div class="kanban-collapsed-content">
                    <button type="button" class="kanban-expand-btn p-1 rounded hover:bg-blue-100 text-blue-500 hover:text-blue-700 mb-2" title="Expand">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
                        </svg>
                    </button>
                    <div class="kanban-vertical-title">
                        <span class="kanban-title-badge inline-flex items-center rounded-full bg-blue-500 px-3 py-1 text-xs font-medium text-white whitespace-nowrap">
                            In Progress (<span class="kanban-count-collapsed">{{ tasksByStatus.in_progress|length }}</span>)
                        </span>
                    </div>
                </div>
            </div>

            {# In Review Column #}
            <div class="kanban-column rounded-lg bg-yellow-50 flex flex-col" data-status="in_review"
                 ondragover="kanbanDragOver(event)"
                 ondragleave="kanbanDragLeave(event)"
                 ondrop="kanbanDrop(event, 'in_review')">
                {# Expanded Header #}
                <div class="kanban-header p-4 pb-0">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <span class="kanban-title-badge inline-flex items-center rounded-full bg-yellow-500 px-3 py-1 text-xs font-medium text-white">
                                In Review (<span class="kanban-count">{{ tasksByStatus.in_review|length }}</span>)
                            </span>
                        </div>
                        <div class="flex items-center gap-1">
                            <button type="button" class="kanban-collapse-btn p-1 rounded hover:bg-yellow-100 text-yellow-600 hover:text-yellow-700" title="Collapse">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="kanban-content p-4 pt-0 flex-1">
                    <div class="kanban-dropzone space-y-3 h-full">
                        {% for task in tasksByStatus.in_review %}
                            {% include 'task/_card.html.twig' with {task: task, draggable: true} %}
                        {% endfor %}
                    </div>
                </div>
                {# Collapsed State #}
                <div class="kanban-collapsed-content">
                    <button type="button" class="kanban-expand-btn p-1 rounded hover:bg-yellow-100 text-yellow-600 hover:text-yellow-700 mb-2" title="Expand">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
                        </svg>
                    </button>
                    <div class="kanban-vertical-title">
                        <span class="kanban-title-badge inline-flex items-center rounded-full bg-yellow-500 px-3 py-1 text-xs font-medium text-white whitespace-nowrap">
                            In Review (<span class="kanban-count-collapsed">{{ tasksByStatus.in_review|length }}</span>)
                        </span>
                    </div>
                </div>
            </div>

            {# Completed Column #}
            <div class="kanban-column rounded-lg bg-green-50 flex flex-col" data-status="completed"
                 ondragover="kanbanDragOver(event)"
                 ondragleave="kanbanDragLeave(event)"
                 ondrop="kanbanDrop(event, 'completed')">
                {# Expanded Header #}
                <div class="kanban-header p-4 pb-0">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <span class="kanban-title-badge inline-flex items-center rounded-full bg-green-500 px-3 py-1 text-xs font-medium text-white">
                                Completed (<span class="kanban-count">{{ tasksByStatus.completed|length }}</span>)
                            </span>
                        </div>
                        <div class="flex items-center gap-1">
                            <button type="button" class="kanban-collapse-btn p-1 rounded hover:bg-green-100 text-green-500 hover:text-green-700" title="Collapse">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="kanban-content p-4 pt-0 flex-1">
                    <div class="kanban-dropzone space-y-3 h-full">
                        {% for task in tasksByStatus.completed %}
                            {% include 'task/_card.html.twig' with {task: task, draggable: true} %}
                        {% endfor %}
                    </div>
                </div>
                {# Collapsed State #}
                <div class="kanban-collapsed-content">
                    <button type="button" class="kanban-expand-btn p-1 rounded hover:bg-green-100 text-green-500 hover:text-green-700 mb-2" title="Expand">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
                        </svg>
                    </button>
                    <div class="kanban-vertical-title">
                        <span class="kanban-title-badge inline-flex items-center rounded-full bg-green-500 px-3 py-1 text-xs font-medium text-white whitespace-nowrap">
                            Completed (<span class="kanban-count-collapsed">{{ tasksByStatus.completed|length }}</span>)
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <script>
        window.draggedCard = null;
        window.dropPlaceholder = null;

        function createDropPlaceholder() {
            const placeholder = document.createElement('div');
            placeholder.className = 'drop-placeholder';
            placeholder.innerHTML = '<span>Drop your card here</span>';
            return placeholder;
        }

        function kanbanDragStart(event, taskId) {
            draggedCard = event.target;
            event.target.classList.add('opacity-40', 'scale-95');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', taskId);

            // Create placeholder
            dropPlaceholder = createDropPlaceholder();
        }

        function kanbanDragEnd(event) {
            event.target.classList.remove('opacity-40', 'scale-95');

            // Remove placeholder
            if (dropPlaceholder && dropPlaceholder.parentNode) {
                dropPlaceholder.remove();
            }
            dropPlaceholder = null;
            draggedCard = null;
        }

        function getInsertPosition(dropzone, clientY) {
            const cards = [...dropzone.querySelectorAll('[data-task-id]')].filter(c => c !== draggedCard);

            for (const card of cards) {
                const rect = card.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;

                if (clientY < midY) {
                    return { insertBefore: card, position: 'before' };
                }
            }

            return { insertBefore: null, position: 'end' };
        }

        function kanbanDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.dataTransfer.dropEffect = 'move';

            const column = event.currentTarget;
            const dropzone = column.querySelector('.kanban-dropzone');

            if (!dropPlaceholder || !dropzone) return;

            const { insertBefore } = getInsertPosition(dropzone, event.clientY);

            // Move placeholder to correct position
            if (insertBefore) {
                if (dropPlaceholder.nextSibling !== insertBefore) {
                    dropzone.insertBefore(dropPlaceholder, insertBefore);
                }
            } else {
                // Append at end
                if (dropPlaceholder.parentNode !== dropzone || dropPlaceholder.nextSibling) {
                    dropzone.appendChild(dropPlaceholder);
                }
            }
        }

        function kanbanDragLeave(event) {
            const relatedTarget = event.relatedTarget;
            const column = event.currentTarget;

            // Only remove if actually leaving the column
            if (!column.contains(relatedTarget)) {
                if (dropPlaceholder && dropPlaceholder.parentNode) {
                    dropPlaceholder.remove();
                }
            }
        }

        async function kanbanDrop(event, newStatus) {
            event.preventDefault();
            event.stopPropagation();

            const column = event.currentTarget;
            const dropzone = column.querySelector('.kanban-dropzone');

            const taskId = event.dataTransfer.getData('text/plain');
            const card = document.querySelector(`[data-task-id="${taskId}"]`);

            if (!card || !dropzone) return;

            // Get the current status from the card's parent column
            const currentColumn = card.closest('.kanban-column');
            const currentStatus = currentColumn ? currentColumn.dataset.status : null;

            // Insert card at placeholder position
            if (dropPlaceholder && dropPlaceholder.parentNode === dropzone) {
                dropzone.insertBefore(card, dropPlaceholder);
                dropPlaceholder.remove();
            } else {
                dropzone.appendChild(card);
            }
            dropPlaceholder = null;

            // Update counts
            updateColumnCounts();

            // Get task title for notification
            const taskTitle = card.querySelector('h4 a')?.textContent?.trim() || 'Task';

            // If same column, persist the new order
            if (currentStatus === newStatus) {
                await persistColumnOrder(dropzone, taskTitle);
                return;
            }

            // Show loading indicator on card
            card.classList.add('opacity-70');
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg';
            loadingOverlay.innerHTML = '<svg class="animate-spin h-5 w-5 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            card.style.position = 'relative';
            card.appendChild(loadingOverlay);

            const statusLabels = {
                'todo': 'To Do',
                'in_progress': 'In Progress',
                'in_review': 'In Review',
                'completed': 'Completed'
            };

            try {
                const kanbanBoard = document.getElementById('kanban-board');
                const urlTemplate = kanbanBoard.dataset.statusUrlTemplate;
                const statusUrl = urlTemplate.replace('__TASK_ID__', taskId);

                const response = await fetch(statusUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) {
                    throw new Error('Failed to update status');
                }

                // Success - remove loading state
                card.classList.remove('opacity-70');
                loadingOverlay.remove();

                // Show success toastr
                Toastr.success('Task Updated', `"${taskTitle}" moved to ${statusLabels[newStatus] || newStatus}`);

            } catch (error) {
                console.error('Error updating task status:', error);

                // Revert: move card back to original column
                if (currentColumn) {
                    currentColumn.querySelector('.kanban-dropzone').appendChild(card);
                    updateColumnCounts();
                }

                // Show error state
                card.classList.remove('opacity-70');
                loadingOverlay.remove();

                // Show error toastr
                Toastr.error('Update Failed', 'Could not update task status. Please try again.');
            }
        }

        function updateColumnCounts() {
            document.querySelectorAll('.kanban-column').forEach(column => {
                const count = column.querySelectorAll('.kanban-dropzone [data-task-id]').length;
                const countEl = column.querySelector('.kanban-count');
                const countElCollapsed = column.querySelector('.kanban-count-collapsed');
                if (countEl) {
                    countEl.textContent = count;
                }
                if (countElCollapsed) {
                    countElCollapsed.textContent = count;
                }
            });
        }

        async function persistColumnOrder(dropzone, taskTitle) {
            // Get all task IDs in the column in order
            const taskIds = [...dropzone.querySelectorAll('[data-task-id]')]
                .map(card => card.dataset.taskId);

            if (taskIds.length === 0) return;

            try {
                const reorderUrl = document.getElementById('kanban-board').dataset.reorderUrl;

                const response = await fetch(reorderUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ taskIds: taskIds })
                });

                if (!response.ok) {
                    throw new Error('Failed to save order');
                }

                Toastr.success('Task Reordered', `"${taskTitle}" position updated`);

            } catch (error) {
                console.error('Error saving task order:', error);
                Toastr.error('Save Failed', 'Could not save task order. Please try again.');
            }
        }

        // Kanban Column Collapse/Expand Functionality
        function initKanbanCollapse() {
            const STORAGE_KEY = 'kanban_collapsed_columns';

            // Load saved collapsed state
            function getCollapsedState() {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : {};
                } catch (e) {
                    return {};
                }
            }

            // Save collapsed state
            function saveCollapsedState(state) {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                } catch (e) {
                    // Ignore storage errors
                }
            }

            // Toggle column collapse
            function toggleColumn(column, collapse) {
                const status = column.dataset.status;
                const state = getCollapsedState();

                if (collapse) {
                    column.classList.add('collapsed');
                    state[status] = true;
                } else {
                    column.classList.remove('collapsed');
                    delete state[status];
                }

                saveCollapsedState(state);
            }

            // Restore saved state on load
            const savedState = getCollapsedState();
            document.querySelectorAll('.kanban-column').forEach(column => {
                const status = column.dataset.status;
                if (savedState[status]) {
                    column.classList.add('collapsed');
                }

                // Add collapse button listener
                const collapseBtn = column.querySelector('.kanban-collapse-btn');
                if (collapseBtn) {
                    collapseBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleColumn(column, true);
                    });
                }

                // Add expand button listener
                const expandBtn = column.querySelector('.kanban-expand-btn');
                if (expandBtn) {
                    expandBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleColumn(column, false);
                    });
                }
            });
        }

        // Initialize collapse functionality when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initKanbanCollapse);
        } else {
            initKanbanCollapse();
        }
        </script>

        <style>
        .drop-placeholder {
            background: #f9fafb;
            border: 1px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1.25rem 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70px;
        }
        .drop-placeholder span {
            color: #9ca3af;
            font-size: 0.8125rem;
            font-weight: 400;
        }

        /* Kanban Grid Layout */
        .kanban-grid {
            display: flex;
            gap: 1rem;
            align-items: stretch;
            min-height: 500px;
            max-height: 70vh;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 0.5rem;
        }

        /* Kanban grid scrollbar */
        .kanban-grid {
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f3f4f6;
        }
        .kanban-grid::-webkit-scrollbar {
            height: 8px;
        }
        .kanban-grid::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }
        .kanban-grid::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
        .kanban-grid::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Kanban Column */
        .kanban-column {
            flex: 1 0 220px;
            min-width: 220px;
            max-width: 400px;
            transition: flex 0.3s ease, min-width 0.3s ease, width 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .kanban-column.collapsed {
            flex: 0 0 48px;
            min-width: 48px;
            max-width: 48px;
        }

        /* Expanded state content */
        .kanban-header {
            flex-shrink: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .kanban-content {
            flex: 1;
            overflow-y: auto;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        /* Column content scrollbar */
        .kanban-content {
            scrollbar-width: thin;
            scrollbar-color: #d1d5db transparent;
        }
        .kanban-content::-webkit-scrollbar {
            width: 6px;
        }
        .kanban-content::-webkit-scrollbar-track {
            background: transparent;
        }
        .kanban-content::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        .kanban-content::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .kanban-column.collapsed .kanban-header,
        .kanban-column.collapsed .kanban-content {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            visibility: hidden;
        }

        /* Collapsed state content */
        .kanban-collapsed-content {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 0.5rem;
            height: 100%;
        }

        .kanban-column.collapsed .kanban-collapsed-content {
            display: flex;
        }

        /* Vertical rotated title */
        .kanban-vertical-title {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            white-space: nowrap;
            margin-top: 0.5rem;
        }

        /* Responsive: stack on mobile */
        @media (max-width: 1023px) {
            .kanban-grid {
                flex-direction: column;
                max-height: none;
                overflow-x: hidden;
                overflow-y: auto;
            }
            .kanban-column {
                flex: none !important;
                min-width: 100% !important;
                max-width: 100% !important;
            }
            .kanban-column.collapsed {
                flex: none !important;
                min-width: 100% !important;
                max-width: 100% !important;
                min-height: 48px;
                max-height: 48px;
            }
            .kanban-content {
                max-height: 300px;
            }
            .kanban-column.collapsed .kanban-collapsed-content {
                flex-direction: row;
                padding: 0.5rem 1rem;
                height: auto;
            }
            .kanban-vertical-title {
                writing-mode: horizontal-tb;
                transform: none;
                margin-top: 0;
                margin-left: 0.5rem;
            }
        }
        </style>
    {% else %}
        {% include 'components/_empty_state.html.twig' with {
            icon: 'task',
            title: 'No tasks assigned',
            description: 'Tasks assigned to you will appear here.'
        } %}
    {% endif %}
</div>
{% endblock %}
